<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Features Demo - Grievance Portal</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 2.5rem;
      }

      .demo-section {
        margin: 30px 0;
        padding: 20px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        background: #f9f9f9;
      }

      .demo-section h2 {
        color: #4caf50;
        margin-top: 0;
        font-size: 1.5rem;
      }

      .btn {
        background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 5px;
        transition: all 0.3s ease;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
      }

      .btn-test {
        background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
      }

      .btn-submit {
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      }

      .result {
        margin: 20px 0;
        padding: 15px;
        border-radius: 8px;
        min-height: 50px;
        font-family: monospace;
        white-space: pre-wrap;
        display: none;
      }

      .result.success {
        background: #e8f5e9;
        border: 2px solid #4caf50;
        color: #2e7d32;
      }

      .result.error {
        background: #ffebee;
        border: 2px solid #f44336;
        color: #c62828;
      }

      .result.info {
        background: #e3f2fd;
        border: 2px solid #2196f3;
        color: #1976d2;
      }

      .form-group {
        margin: 15px 0;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .status-update {
        background: #fff3e0;
        border: 2px solid #ff9800;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
      }

      .timeline-item {
        background: white;
        border-left: 4px solid #4caf50;
        margin: 10px 0;
        padding: 15px;
        border-radius: 0 8px 8px 0;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .similarity-warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .emoji {
        font-size: 24px;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4caf50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ü§ñ AI-Powered Grievance Portal - Features Demo</h1>

      <div class="demo-section">
        <h2>üîç Feature 1: Similarity Detection</h2>
        <p>
          Test the AI similarity detection system that identifies duplicate or
          related grievances.
        </p>
        <button class="btn btn-test" onclick="testSimilarityDetection()">
          Test Similarity Detection
        </button>
        <button class="btn btn-test" onclick="checkSpecificSimilarity()">
          Check Custom Text Similarity
        </button>
        <div id="similarity-result" class="result"></div>

        <div style="margin-top: 20px">
          <label for="similarity-text"
            >Test your own text for similarity:</label
          >
          <textarea
            id="similarity-text"
            placeholder="Enter petition text to check for similar grievances..."
          >
Water supply problem in our locality. No water for 3 days.</textarea
          >
        </div>
      </div>

      <div class="demo-section">
        <h2>üì¢ Feature 2: Automated Notifications</h2>
        <p>
          Test the automated notification system that sends SMS/Email alerts to
          citizens.
        </p>
        <button class="btn btn-test" onclick="testNotificationSystem()">
          Test Notification System
        </button>
        <button class="btn btn-test" onclick="showNotificationLogs()">
          View Notification Logs
        </button>
        <div id="notification-result" class="result"></div>
      </div>

      <div class="demo-section">
        <h2>üìÖ Feature 3: Timeline Tracking</h2>
        <p>
          Experience the complete timeline tracking system with detailed audit
          trails.
        </p>
        <div class="grid">
          <div>
            <h3>Submit Test Grievance</h3>
            <div class="form-group">
              <label for="test-name">Name:</label>
              <input type="text" id="test-name" value="John Doe" />
            </div>
            <div class="form-group">
              <label for="test-phone">Phone:</label>
              <input type="text" id="test-phone" value="9876543210" />
            </div>
            <div class="form-group">
              <label for="test-subject">Subject:</label>
              <input
                type="text"
                id="test-subject"
                value="Water supply disruption in residential area"
              />
            </div>
            <div class="form-group">
              <label for="test-description">Description:</label>
              <textarea id="test-description">
No water supply in our residential area for the past 3 days. Multiple families are affected and need immediate attention.</textarea
              >
            </div>
            <button class="btn btn-submit" onclick="submitTestGrievance()">
              Submit Test Grievance
            </button>
          </div>

          <div>
            <h3>Update Status & View Timeline</h3>
            <div class="form-group">
              <label for="tracking-id">Tracking ID:</label>
              <input
                type="text"
                id="tracking-id"
                placeholder="Will be filled after submission"
              />
            </div>
            <div class="form-group">
              <label for="new-status">New Status:</label>
              <select id="new-status">
                <option value="in_progress">In Progress</option>
                <option value="resolved">Resolved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
            <div class="form-group">
              <label for="status-comment">Comment:</label>
              <textarea
                id="status-comment"
                placeholder="Add a comment about this status update..."
              >
Officer assigned to investigate the water supply issue.</textarea
              >
            </div>
            <button class="btn btn-submit" onclick="updateGrievanceStatus()">
              Update Status
            </button>
            <button class="btn btn-test" onclick="viewTimeline()">
              View Timeline
            </button>
          </div>
        </div>
        <div id="timeline-result" class="result"></div>
      </div>

      <div class="demo-section">
        <h2>üìä Administrative Features</h2>
        <p>Access administrative functions for monitoring and testing.</p>
        <button class="btn btn-test" onclick="getReminders()">
          View Reminder System
        </button>
        <button class="btn btn-test" onclick="getReminderStats()">
          Reminder Statistics
        </button>
        <button class="btn btn-test" onclick="runFullSystemTest()">
          Run Full System Test
        </button>
        <div id="admin-result" class="result"></div>
      </div>
    </div>

    <script src="js/api.js"></script>
    <script>
      const API_BASE_URL = "http://localhost:8000";
      const TEST_DEPARTMENT = "Tamil Nadu Water Supply and Drainage Board";

      function showResult(elementId, content, type = "info") {
        const element = document.getElementById(elementId);
        element.innerHTML = content;
        element.className = `result ${type}`;
        element.style.display = "block";
      }

      function showLoading(elementId) {
        showResult(
          elementId,
          '<div class="loading"></div> Processing...',
          "info"
        );
      }

      async function testSimilarityDetection() {
        showLoading("similarity-result");

        try {
          const response = await fetch(
            `${API_BASE_URL}/admin/test_similarity`,
            {
              method: "POST",
            }
          );
          const data = await response.json();

          if (data.success) {
            showResult(
              "similarity-result",
              `‚úÖ Similarity Detection Working!\n\n` +
                `Test Text: "${data.test_text}"\n` +
                `Department: ${data.department}\n` +
                `Similar Grievances Found: ${data.similar_found}\n\n` +
                `Message: ${data.message}`,
              "success"
            );
          } else {
            showResult(
              "similarity-result",
              `‚ùå Test Failed: ${data.message}`,
              "error"
            );
          }
        } catch (error) {
          showResult(
            "similarity-result",
            `‚ùå Error: ${error.message}`,
            "error"
          );
        }
      }

      async function checkSpecificSimilarity() {
        const text = document.getElementById("similarity-text").value;
        if (!text.trim()) {
          showResult(
            "similarity-result",
            "‚ùå Please enter some text to check",
            "error"
          );
          return;
        }

        showLoading("similarity-result");

        try {
          const params = new URLSearchParams({
            department: TEST_DEPARTMENT,
            text: text,
            threshold: 0.6,
          });

          const response = await fetch(
            `${API_BASE_URL}/grievance/similar?${params}`
          );
          const data = await response.json();

          if (data.success) {
            const similar = data.similar_grievances || [];
            let resultText = `üîç Similarity Check Results:\n\n`;
            resultText += `Text Analyzed: "${text}"\n`;
            resultText += `Similar Grievances Found: ${similar.length}\n\n`;

            if (similar.length > 0) {
              resultText += `Similar Cases:\n`;
              similar.forEach((item, index) => {
                resultText += `${index + 1}. ${item.grievance_id} (${(
                  item.similarity_score * 100
                ).toFixed(1)}% match)\n`;
                resultText += `   Subject: ${item.subject}\n`;
                resultText += `   Preview: ${item.description}\n\n`;
              });
            } else {
              resultText += `No similar grievances found (this is normal for new text).`;
            }

            showResult("similarity-result", resultText, "success");
          } else {
            showResult(
              "similarity-result",
              `‚ùå Check Failed: ${data.message}`,
              "error"
            );
          }
        } catch (error) {
          showResult(
            "similarity-result",
            `‚ùå Error: ${error.message}`,
            "error"
          );
        }
      }

      async function testNotificationSystem() {
        showLoading("notification-result");

        try {
          const response = await fetch(
            `${API_BASE_URL}/admin/test_notifications`,
            {
              method: "POST",
            }
          );
          const data = await response.json();

          if (data.success) {
            showResult(
              "notification-result",
              `‚úÖ Notification System Working!\n\n` +
                `Test notification sent successfully.\n` +
                `Check the server console for SMS/Email output.\n\n` +
                `üì± SMS and üìß Email notifications will appear in the backend console.`,
              "success"
            );
          } else {
            showResult(
              "notification-result",
              `‚ùå Test Failed: ${data.message}`,
              "error"
            );
          }
        } catch (error) {
          showResult(
            "notification-result",
            `‚ùå Error: ${error.message}`,
            "error"
          );
        }
      }

      async function showNotificationLogs() {
        showLoading("notification-result");

        try {
          const response = await fetch(
            `${API_BASE_URL}/admin/notifications?limit=5`
          );
          const data = await response.json();

          if (data.success) {
            const notifications = data.notifications || [];
            let resultText = `üìß Recent Notification Logs (${notifications.length} entries):\n\n`;

            if (notifications.length === 0) {
              resultText += `No notifications sent yet. Submit and update a grievance to see notifications.`;
            } else {
              notifications.forEach((notif, index) => {
                resultText += `${index + 1}. Grievance: ${
                  notif.grievance_id
                }\n`;
                resultText += `   Recipient: ${notif.recipient_name} (${notif.recipient_phone})\n`;
                resultText += `   Status Change: ${notif.old_status} ‚Üí ${notif.new_status}\n`;
                resultText += `   Sent: ${new Date(
                  notif.sent_at
                ).toLocaleString()}\n\n`;
              });
            }

            showResult("notification-result", resultText, "success");
          } else {
            showResult(
              "notification-result",
              `‚ùå Failed to load logs: ${data.message}`,
              "error"
            );
          }
        } catch (error) {
          showResult(
            "notification-result",
            `‚ùå Error: ${error.message}`,
            "error"
          );
        }
      }

      async function submitTestGrievance() {
        showLoading("timeline-result");

        try {
          const grievanceData = {
            name: document.getElementById("test-name").value,
            phone: document.getElementById("test-phone").value,
            address: "Test Address, Test City",
            petition_type: "Complaint",
            petition_subject: document.getElementById("test-subject").value,
            petition_description:
              document.getElementById("test-description").value,
            category: TEST_DEPARTMENT,
          };

          const response = await fetch(`${API_BASE_URL}/submit_to_department`, {
            method: "POST",
            body: new URLSearchParams(grievanceData),
          });
          const data = await response.json();

          if (data.tracking_id) {
            // Fill the tracking ID field
            document.getElementById("tracking-id").value = data.tracking_id;

            let resultText = `‚úÖ Grievance Submitted Successfully!\n\n`;
            resultText += `Tracking ID: ${data.tracking_id}\n`;
            resultText += `Department: ${data.department}\n`;
            resultText += `Priority: ${data.priority}\n`;
            resultText += `Similarity Detected: ${data.similarity_detected}\n`;

            if (data.similarity_detected) {
              resultText += `Similar Grievances: ${data.similar_grievances_count}\n\n`;
              if (
                data.similar_grievances &&
                data.similar_grievances.length > 0
              ) {
                resultText += `‚ö†Ô∏è SIMILARITY WARNING:\n`;
                data.similar_grievances.forEach((similar, index) => {
                  resultText += `${index + 1}. ${similar.grievance_id} (${(
                    similar.similarity_score * 100
                  ).toFixed(1)}% match)\n`;
                });
              }
            }

            resultText += `\n‚ú® Timeline initialized with submission entry.`;
            resultText += `\nNow you can update the status to see notifications!`;

            showResult("timeline-result", resultText, "success");
          } else {
            showResult(
              "timeline-result",
              `‚ùå Submission Failed: ${data.error}`,
              "error"
            );
          }
        } catch (error) {
          showResult("timeline-result", `‚ùå Error: ${error.message}`, "error");
        }
      }

      async function updateGrievanceStatus() {
        const trackingId = document.getElementById("tracking-id").value;
        if (!trackingId) {
          showResult(
            "timeline-result",
            "‚ùå Please submit a grievance first to get a tracking ID",
            "error"
          );
          return;
        }

        showLoading("timeline-result");

        try {
          const updateData = {
            grievance_id: trackingId,
            status: document.getElementById("new-status").value,
            department: TEST_DEPARTMENT,
            comment: document.getElementById("status-comment").value,
          };

          const response = await fetch(
            `${API_BASE_URL}/update_grievance_status`,
            {
              method: "POST",
              body: new URLSearchParams(updateData),
            }
          );
          const data = await response.json();

          if (data.success) {
            let resultText = `‚úÖ Status Updated Successfully!\n\n`;
            resultText += `Grievance ID: ${trackingId}\n`;
            resultText += `New Status: ${updateData.status}\n`;
            resultText += `Comment: ${updateData.comment}\n`;
            resultText += `Timeline Updated: ${
              data.timeline_update?.date || "Yes"
            }\n`;
            resultText += `Notification Sent: ${
              data.notification_sent ? "Yes" : "No"
            }\n\n`;
            resultText += `üìß Check the server console for SMS/Email notifications!`;

            showResult("timeline-result", resultText, "success");
          } else {
            showResult(
              "timeline-result",
              `‚ùå Update Failed: ${data.message}`,
              "error"
            );
          }
        } catch (error) {
          showResult("timeline-result", `‚ùå Error: ${error.message}`, "error");
        }
      }

      async function viewTimeline() {
        const trackingId = document.getElementById("tracking-id").value;
        if (!trackingId) {
          showResult(
            "timeline-result",
            "‚ùå Please submit a grievance first to get a tracking ID",
            "error"
          );
          return;
        }

        showLoading("timeline-result");

        try {
          const params = new URLSearchParams({
            tracking_id: trackingId,
            department: TEST_DEPARTMENT,
          });

          const response = await fetch(
            `${API_BASE_URL}/grievance/timeline?${params}`
          );
          const data = await response.json();

          if (data.success) {
            const timeline = data.timeline || [];
            let resultText = `üìÖ Timeline for ${trackingId} (${timeline.length} entries):\n\n`;

            if (timeline.length === 0) {
              resultText += `No timeline entries found. This might be an old grievance without the new timeline structure.`;
            } else {
              timeline.forEach((entry, index) => {
                resultText += `${index + 1}. ${entry.date} ${
                  entry.time || ""
                }\n`;
                resultText += `   Status: ${entry.status}\n`;
                resultText += `   Comment: ${entry.comment}\n`;
                resultText += `   Type: ${entry.update_type}\n\n`;
              });
            }

            showResult("timeline-result", resultText, "success");
          } else {
            showResult(
              "timeline-result",
              `‚ùå Timeline Failed: ${data.message}`,
              "error"
            );
          }
        } catch (error) {
          showResult("timeline-result", `‚ùå Error: ${error.message}`, "error");
        }
      }

      async function runFullSystemTest() {
        showLoading("admin-result");

        try {
          let resultText = `üß™ Running Full System Test...\n\n`;

          // Test 1: Similarity Detection
          resultText += `1. Testing Similarity Detection...\n`;
          const similarityTest = await fetch(
            `${API_BASE_URL}/admin/test_similarity`,
            { method: "POST" }
          );
          const similarityData = await similarityTest.json();
          resultText += `   Result: ${
            similarityData.success ? "‚úÖ PASS" : "‚ùå FAIL"
          }\n\n`;

          // Test 2: Notification System
          resultText += `2. Testing Notification System...\n`;
          const notificationTest = await fetch(
            `${API_BASE_URL}/admin/test_notifications`,
            { method: "POST" }
          );
          const notificationData = await notificationTest.json();
          resultText += `   Result: ${
            notificationData.success ? "‚úÖ PASS" : "‚ùå FAIL"
          }\n\n`;

          // Test 3: Basic API Health
          resultText += `3. Testing API Health...\n`;
          const healthTest = await fetch(`${API_BASE_URL}/`);
          const healthData = await healthTest.json();
          resultText += `   Result: ${
            healthData.message ? "‚úÖ PASS" : "‚ùå FAIL"
          }\n\n`;

          resultText += `üéØ Full System Test Complete!\n`;
          resultText += `Check individual features above for detailed testing.`;

          showResult("admin-result", resultText, "success");
        } catch (error) {
          showResult(
            "admin-result",
            `‚ùå System Test Error: ${error.message}`,
            "error"
          );
        }
      }

      // Show startup message
      window.addEventListener("load", function () {
        showResult(
          "similarity-result",
          "üëã Welcome to the AI Features Demo!\n\n" +
            "This page demonstrates the new AI-powered features:\n" +
            "‚Ä¢ Similarity Detection using TF-IDF\n" +
            "‚Ä¢ Automated Notifications\n" +
            "‚Ä¢ Timeline Tracking\n\n" +
            "Click the buttons above to test each feature!",
          "info"
        );
      });
    </script>
  </body>
</html>
